strip.background = element_rect(fill ="#787c84"),
strip.text = element_text(colour = "white"),
axis.line = element_line(colour = "black")
)
ggsave("./Plots/plot08_compare_FREQvsSEV_scatter.png")
ggplot(risk.df) +
geom_point(
aes(y = `Risk Category`, x = Business, size = `Net Loss`),
colour = dataseer.cols[2]
) +
scale_size_continuous(
labels = amtLab,
range = c(
1,
1 * sqrt(max(risk.df$`Net Loss`) / min(risk.df$`Net Loss`))
)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
guides(size = guide_legend(label.position = "left")) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = NA),
panel.grid.major = element_line(colour = "#c5e3fb"),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
str(risk.df)
cache.path <- file.path(".", "Data")
stage.path <- file.path("~/Data", "oprisk-report")
source("./Scripts/template.R")
library(magrittr)
# Raw
CY2014.df <- file.path(cache.path, "CY2014.rds") %>% readRDS()
## Needed only for order of business-lines
biz.path <- file.path(cache.path, "out00_total-netloss-per-biz-2014")
biz.df <- readRDS(paste0(biz.path, ".rds"))
library(dplyr)
library(googledrive)
library(writexl)
library(ggplot2)
library(scales)
library(stringr)
risk.df <- CY2014.df %>%
group_by(Business, `Risk Category`) %>%
summarise(
Freq = n(), # Assumes unique events
`Gross Loss` = sum(`Estimated Gross Loss`),
`Recovery Amount` = sum(`Recovery Amount`),
`Net Loss` = sum(`Net Loss`)
) %>%
ungroup() %>%
mutate(
`Recovery Rate` = `Recovery Amount` / `Gross Loss`,
Severity = `Net Loss` / Freq
)
risk.path <- file.path(cache.path, "out01_risk-summary-per-biz-2014")
risk.rds <- paste0(risk.path, ".rds")
risk.xlsx <- paste0(risk.path, ".xlsx")
amtLab <- function(x){
# See script02_report 2014 comparisons.R
temp.amt <- x / 1e6
temp.lab <- paste0(temp.amt, "m")
return(temp.lab)
}
## Order bars
biz.names <- biz.df$Business[order(biz.df$`Net Loss`)] %>% as.character()
risk.df$Business %<>% factor(levels = rev(biz.names))
## dataseer palette
biz.cols <- dataseer.cols[1:length(biz.names)]
names(biz.cols) <- rev(biz.names)
## Order risk
riskSum.df <- risk.df %>%
group_by(`Risk Category`) %>%
summarise(`Net Loss` = sum(`Net Loss`))
risk.names <- riskSum.df$`Risk Category`[order(riskSum.df$`Net Loss`)]
risk.df$`Risk Category` %<>% factor(levels = risk.names)
## dataseer palette
risk.cols <- rev(dataseer.cols[-length(dataseer.cols)])[1:length(unique(risk.df$`Risk Category`))]
names(risk.cols) <- rev(risk.names)
ggplot(risk.df) +
geom_bar(
aes(x = Business, y = `Net Loss`, fill = `Risk Category`),
stat = "identity"
) +
# scale_x_discrete(name = NULL) +
scale_y_continuous(labels = amtLab, expand = c(0, 0)) +
scale_fill_manual(values = risk.cols) +
# guides(fill = guide_legend(reverse = FALSE)) +
theme(
plot.background = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 90, hjust = 1)
)
ggplot(risk.df) +
geom_bar(
aes(x = `Risk Category`, y = `Net Loss`, fill = Business),
stat = "identity"
) +
# scale_x_discrete(name = NULL) +
scale_y_continuous(labels = amtLab, expand = c(0, 0)) +
scale_fill_manual(values = biz.cols) +
coord_flip() +
theme(
plot.background = element_blank(),
panel.background = element_blank(),
axis.line = element_line(colour = "black")
)
lineBreak <- function(x) str_replace_all(x, c("and " = "and\n"))
spaceBreak <- function(x) str_replace_all(x, c(" " = "\n"))
ggplot(risk.df) +
geom_point(
aes(y = `Risk Category`, x = Business, size = `Net Loss`),
colour = dataseer.cols[2]
) +
scale_size_continuous(
labels = amtLab,
range = c(
1,
1 * sqrt(max(risk.df$`Net Loss`) / min(risk.df$`Net Loss`))
)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
guides(size = guide_legend(label.position = "left")) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = NA),
panel.grid.major = element_line(colour = "#c5e3fb"),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
str(risk.df)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, colour = `Recovery Rate`)
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
guides(size = guide_legend(label.position = "left")) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = NA),
panel.grid.major = element_line(colour = "#c5e3fb"),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
guides(size = guide_legend(label.position = "left")) +
theme(
plot.background = element_blank(),
panel.background = element_blank(colour = "black", fill = NA),
panel.grid.major = element_blank(colour = "#c5e3fb"),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
guides(size = guide_legend(label.position = "left")) +
theme(
plot.background = element_blank(),
panel.background = element_blank(),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
guides(size = guide_legend(label.position = "left")) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = NA),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
dataseer.cols %>% show_col()
dataseer.cols
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(low = "black", high = "#82f376") +
guides(size = guide_legend(label.position = "left")) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(low = "black", high = "#82f376", limits = c(0, 0.40)) +
guides(size = guide_legend(label.position = "left")) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(low = "black", high = "#82f376", limits = c(0, 0.40), labels = percent) +
guides(size = guide_legend(label.position = "left")) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(low = "black", high = "#82f376", limits = c(0, 0.40), labels = percent) +
guides(fill = guide_legend(label.position = "left")) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
?guide_legend
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(
low = "black", high = "#82f376", limits = c(0, 0.40), labels = percent
) +
guides(fill = guide_legend(label.position = "left", hjust = 1)) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(
low = "black", high = "#82f376", limits = c(0, 0.40), labels = percent
) +
guides(fill = guide_legend(label.position = "left", hjust = 0)) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(
low = "black", high = "#82f376", limits = c(0, 0.40), labels = percent
) +
guides(fill = guide_legend(label.position = "left", label.hjust = 0)) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(
low = "black", high = "#82f376", limits = c(0, 0.40), labels = percent
) +
guides(fill = guide_legend(label.position = "left", label.hjust = 1)) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(
low = "black", high = "#82f376", limits = c(0, 0.40), labels = percent
) +
guides(fill = guide_legend(label.position = "left", label.hjust = 1, reverse = TRUE)) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
min(risk.df$`Recovery Rate`)
dataseer.cols %>% show_col()
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(
low = "black", high = "#82f376",
limits = c(0.20, 0.40),
labels = percent
) +
guides(fill = guide_legend(label.position = "left", label.hjust = 1, reverse = TRUE)) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(
low = "black", high = "#82f376",
limits = c(0, 0.40),
labels = percent
) +
guides(fill = guide_legend(label.position = "left", label.hjust = 1, reverse = TRUE)) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = "black", fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(
low = "black", high = "#82f376",
limits = c(0, 0.40),
labels = percent
) +
guides(fill = guide_legend(label.position = "left", label.hjust = 1, reverse = TRUE)) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = NA, fill = "black"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
dataseer.cols
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(
low = "black", high = "#82f376",
limits = c(0, 0.40),
labels = percent
) +
guides(fill = guide_legend(label.position = "left", label.hjust = 1, reverse = TRUE)) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = NA, fill = "#787c84"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(
low = "#787c84", high = "#82f376",
limits = c(0, 0.40),
labels = percent
) +
guides(fill = guide_legend(label.position = "left", label.hjust = 1, reverse = TRUE)) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = NA, fill = "#787c84"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggplot(risk.df) +
geom_tile(
aes(y = `Risk Category`, x = Business, fill = `Recovery Rate`)
) +
scale_y_discrete(labels = lineBreak) +
scale_x_discrete(position = "top", labels = spaceBreak) +
scale_fill_continuous(
low = "#787c84", high = "#82f376",
limits = c(0.10, 0.40),
labels = percent
) +
guides(fill = guide_legend(label.position = "left", label.hjust = 1, reverse = TRUE)) +
theme(
plot.background = element_blank(),
panel.background = element_rect(colour = NA, fill = "#787c84"),
panel.grid.major = element_blank(),
axis.line = element_line(colour = "black"),
axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 0.5),
axis.ticks = element_blank(),
legend.key = element_blank()
)
ggsave("./Plots/plot12_compare_RISKvsBIZ_heat.png")
